<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>各校備取進度查詢(多系組查詢)</title>
    <link rel="stylesheet" href="./css/loadingHamster.css" type="text/css">
    <style>
        table,
        th,
        td {
            border: 1px solid;
            text-align: center;
        }
        
        button {
            cursor: pointer;
        }
        
        .toggleBtn {
            background-color: transparent;
            border: 0;
        }
        
        .togglePanel {
            border: 0.2rem solid;
            padding: 0.5vw 1vw;
        }
        
        .toggleHeader {
            margin: 1vw;
        }
        
        .toggleContent {
            display: none;
            flex-direction: column;
            gap: 1vw
        }
    </style>
</head>

<body style="font-family: 'Source Code Pro', monospace;">
    <nav>
        <a href="./">快速查詢</a> |
        <a href="./group.html">多系組查詢</a>
    </nav>
    <br>
    <!-- Copy by https://uiverse.io/Nawsome/wet-mayfly-23 -->
    <div id="loadingPage" style="height:100vh; display: flex; gap:2vw; justify-content: center; align-items: center; flex-direction: column; ">
        <div aria-label="Orange and tan hamster running in a metal wheel" role="img" class="wheel-and-hamster">
            <div class="wheel"></div>
            <div class="hamster">
                <div class="hamster__body">
                    <div class="hamster__head">
                        <div class="hamster__ear"></div>
                        <div class="hamster__eye"></div>
                        <div class="hamster__nose"></div>
                    </div>
                    <div class="hamster__limb hamster__limb--fr"></div>
                    <div class="hamster__limb hamster__limb--fl"></div>
                    <div class="hamster__limb hamster__limb--br"></div>
                    <div class="hamster__limb hamster__limb--bl"></div>
                    <div class="hamster__tail"></div>
                </div>
            </div>
            <div class="spoke"></div>
        </div>
        <div style="text-align:center">Please wait while the data is loading<br>Thanks for your patient!ヾ(•ω•`)o</div>
    </div>

    <div id="loadedPage" style="display: flex; flex-direction: column; gap: 1vh;">


        <div class="togglePanel" id="createQueryPanel">
            <header class="toggleHeader">
                <button class="toggleBtn" id="createQueryToggle" onclick="openToggle('createQuery')">▶</button>【建立查詢碼】
            </header>
            <div class="toggleContent" id="createQueryContent">
                <div>
                    <select id="schoolSelect">
                    <option value="">
                        請選擇學校
                    </option>
                    <option value="NYCU">
                        國立交通大學
                    </option>
                    <option value="NCKU">
                        國立成功大學
                    </option>
                    <option value="CCU">
                        國立中正大學
                    </option>
                    <option value="NCU">
                        國立中央大學
                    </option>
                </select>
                    <select id="examSelect">
                    <option value="NCU">
                    </option>
                </select>
                    <select id="groupSelect">
                    <option value="NCU">
                    </option>
                </select>
                </div>
                <div>
                    <label for="userIdInput">考生編號/准考證號碼(非必填):</label>
                    <input type="text" id="userIdInput" value="" name="userId" style="width: 20vw;">
                    <button onclick="addNewQuery()" style="width: 10vw;">新增查詢</button>
                </div>
                <div>
                    <button onclick="createQueryCode()" style="width: 10vw;">建立/更新查詢碼</button>
                    <button onclick="copyQueryCode()" style="width: 10vw;">複製查詢碼</button>
                </div>
                <input type="text" placeholder="查詢碼建立結果顯示於此" id="queryCodeOutput" readonly="readonly">
                <table id="queryListTable">
                    <thead>
                        <tr>
                            <th>學校</th>
                            <th>考試類別</th>
                            <th>系組</th>
                            <th>考生編號/准考證號碼</th>
                            <th>刪除?</th>
                        </tr>
                    </thead>
                    <tbody id="queryListTableBody">
                    </tbody>
                </table>
            </div>

        </div>
        <div id="groupQueryPanel" class="togglePanel">
            <header class="toggleHeader">
                <button class="toggleBtn" id="groupQueryToggle" onclick="openToggle('groupQuery')">▶</button>【進行多系組查詢】
            </header>
            <div class="toggleContent" id="groupQueryContent">
                <label for="queryCodeInput">查詢碼:</label>
                <input type="text" id="queryCodeInput" value="" name="queryCodeInput">
                <button onclick="getGroupQuery()" style="width: 10vw;">開始查詢</button>
                <br>
                <div>[註]備取進度:目前最後一位報到者的位置 (若尚未有遞補名額，則顯示"目前尚未有遞補名額")</div>
                <table id="resultListTable">
                    <thead>
                        <tr>
                            <th>學校</th>
                            <th>考試類別</th>
                            <th>系組</th>
                            <th>系組備取狀況</th>
                            <th>考生編號/准考證號碼</th>
                            <th>考生查詢結果</th>
                        </tr>
                    </thead>
                    <tbody id="resultListTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        checkDatabaseConnection();
        reset();
        const urlHeader = "http://127.0.0.1:3000"

        function checkDatabaseConnection(onConnected = null) {
            document.getElementById('loadedPage').style.display = "none";
            let preStatus = "closed";
            const statusGetter = setInterval(async() => {
                const url = urlHeader + '/getStatus'
                const res = await fetch(url, {
                    method: 'GET'
                })
                const status = (await res.json()).status;
                if (preStatus != status && status == "ok") { //status:ok
                    clearInterval(statusGetter)
                    preStatus = status;
                    document.getElementById('loadingPage').style.display = "none";
                    document.getElementById('loadedPage').style.display = "block";
                    if (onConnected != null) {
                        onConnected();
                    }
                }
            }, 1000)
        }

        function reset() {
            document.getElementById("schoolSelect").selectedIndex = 0;
            document.getElementById("examSelect").selectedIndex = 0;
            document.getElementById("groupSelect").selectedIndex = 0;
            document.getElementById("userIdInput").value = "";
            document.getElementById("queryCodeOutput").value = "";
            document.getElementById("queryCodeInput").value = "";
        }

        document.getElementById("schoolSelect").onchange = () => {
            selectSchool()
        };

        async function selectSchool() {
            const selectedSchool = document.getElementById("schoolSelect").value;
            if (selectedSchool == "") {
                return;
            }

            const url = urlHeader + `/getExamSelect?school=${selectedSchool}`;
            const res = await fetch(url, {
                method: 'GET',
            })
            const examList = await res.json();
            if (res.status == 500) {
                checkDatabaseConnection(() => {
                    selectSchool()
                });
            }
            let html = " <option value = '' > 請選擇考試類別 </option>"

            for (const exam of examList) {
                html += `<option value = ${exam.examNo} >  ${exam.name}</option>`
            }
            document.getElementById("examSelect").innerHTML = html;
            document.getElementById("groupSelect").innerHTML = "";
            document.getElementById("userIdInput").value = "";
        }




        document.getElementById("examSelect").onchange = () => {
            selectExam();
        }

        async function selectExam() {
            const selectedSchool = document.getElementById("schoolSelect").value;
            const selectedExam = document.getElementById("examSelect").value;
            if (selectedSchool == "" || selectedExam == "") {
                return;
            }

            const url = urlHeader + `/getGroupSelect?school=${selectedSchool}&examNo=${selectedExam}`;
            const res = await fetch(url, {
                method: 'GET',
            })

            if (res.status == 500) {
                checkDatabaseConnection(() => {
                    selectExam();
                });
            }
            const groupList = await res.json()
            let html = " <option value = '' > 請選擇系組 </option>"

            for (const group of groupList) {
                html += `<option value = ${group.groupNo} >  ${group.name}</option>`
            }
            document.getElementById("groupSelect").innerHTML = html;
            document.getElementById("userIdInput").value = "";

        }





        //toggles settings
        function openToggle(prefix) {
            document.getElementById(`${prefix}Content`).style.display = "flex";
            document.getElementById(`${prefix}Toggle`).onclick = () => {
                closeToggle(prefix)
            };
            document.getElementById(`${prefix}Toggle`).innerText = "▼";
        }

        function closeToggle(prefix) {
            document.getElementById(`${prefix}Content`).style.display = "none";
            document.getElementById(`${prefix}Toggle`).onclick = () => {
                openToggle(prefix);
            }
            document.getElementById(`${prefix}Toggle`).innerText = "▶";
        }


        function addNewQuery() {
            const schoolSelect = document.getElementById("schoolSelect");
            const examSelect = document.getElementById("examSelect");
            const groupSelect = document.getElementById("groupSelect");
            const userId = document.getElementById("userIdInput");
            if (schoolSelect.value == "" || examSelect.value == "" || groupSelect.value == "") {
                return;
            }


            const queryListTableBody = document.getElementById('queryListTableBody');
            const row = queryListTableBody.insertRow(-1);

            const schoolCell = row.insertCell(0);
            const examCell = row.insertCell(1);
            const groupCell = row.insertCell(2);
            const userIdCell = row.insertCell(3);
            const toDelCell = row.insertCell(4);

            schoolCell.value = schoolSelect.value;
            examCell.value = examSelect.value;
            groupCell.value = groupSelect.value;
            userIdCell.value = userId.value;
            schoolCell.innerHTML = schoolSelect.options[schoolSelect.selectedIndex].text;
            examCell.innerHTML = examSelect.options[examSelect.selectedIndex].text;
            groupCell.innerHTML = groupSelect.options[groupSelect.selectedIndex].text;
            userIdCell.innerHTML = userId.value;
            toDelCell.innerHTML = `<button onclick='deleteQuery(this)'>刪除</button>`

            userId.value = "";
        }

        function deleteQuery(delBtn) {
            const row = delBtn.parentNode.parentNode; //delBtn.parentNode(td).parentNode(tr)
            row.parentNode.removeChild(row);
        }

        function createQueryCode() {
            const queryListTable = document.getElementById('queryListTableBody');
            const queryList = [];
            for (let row of queryListTable.rows) {
                queryList.push({
                    school: {
                        name: row.cells[0].innerText,
                        value: row.cells[0].value
                    },
                    examNo: {
                        name: row.cells[1].innerText,
                        value: row.cells[1].value
                    },
                    groupNo: {
                        name: row.cells[2].innerText,
                        value: row.cells[2].value,
                    },
                    userId: row.cells[3].value
                })
            }

            document.getElementById("queryCodeOutput").value = jsonToBase64({
                result: queryList
            });

        }

        function copyQueryCode() {
            const text = document.getElementById("queryCodeOutput");
            text.select();
            document.execCommand("copy");
        }




        async function getGroupQuery() {

            const queryListJson = encodeBase64ToJson(document.getElementById("queryCodeInput").value);
            const queryList = queryListJson.result;

            const resultListTableBody = document.getElementById('resultListTableBody');
            resultListTableBody.innerHTML = "";

            for (let query of queryList) {
                const row = resultListTableBody.insertRow(-1);
                const schoolCell = row.insertCell(0);
                const examCell = row.insertCell(1);
                const groupCell = row.insertCell(2);
                const groupResultCell = row.insertCell(3);

                schoolCell.innerHTML = query.school.name;
                examCell.innerHTML = query.examNo.name;
                groupCell.innerHTML = query.groupNo.name;
                groupResultCell.innerHTML = await getReserveProcess(query.school.value, query.examNo.value, query.groupNo.value);

                if (query.userId != "") {
                    const userIdCell = row.insertCell(4);
                    const userResultCell = row.insertCell(5);

                    userIdCell.innerHTML = query.userId;
                    userResultCell.innerHTML = await getUserRank(query.school.value, query.examNo.value, query.groupNo.value, query.userId);
                }
            }
        }




        async function getUserRank(queriedSchool, queriedExam, queriedGroup, queriedUserId) {
            if (queriedSchool == "" || queriedExam == "" || queriedGroup == "" || queriedUserId == "") {
                return;
            }


            const groupId = queriedSchool + "_" + queriedExam + "_" + queriedGroup;

            const url = urlHeader + `/getUserRank?groupId=${groupId}&userId=${queriedUserId}`;
            const res = await fetch(url, {
                method: 'GET',
            })
            if (res.status == 500) {
                checkDatabaseConnection(() => {
                    getUserRank(queriedSchool, queriedExam, queriedGroup, queriedUserId)
                });
            }
            const userRank = await res.json();
            if (userRank == null)
                reuturn `查無此考生`;
            else {
                return `名次:${userRank.rank}<br>報到狀況:${userRank.status}`;
            }
        }

        async function getReserveProcess(queriedSchool, queriedExam, queriedGroup) {
            if (queriedSchool == "" || queriedExam == "" || queriedGroup == "") {
                return;
            }
            const url = urlHeader + `/getReserveProcess?school=${queriedSchool}&examNo=${queriedExam}&groupNo=${queriedGroup}`;
            const res = await fetch(url, {
                method: 'GET',
            })
            if (res.status == 500) {
                checkDatabaseConnection(() => {
                    getReserveProcess(queriedSchool, queriedExam, queriedGroup)
                });
            }
            const group = await res.json();
            return `已報到人數/正取招收人數:${group.registered}/${group.want}<br>=>備取進度:${group.currentReserve}`
        }

        function jsonToBase64(jsonObj) {
            const jsonString = JSON.stringify(jsonObj)
            return window.btoa(unescape(encodeURIComponent(jsonString)))
        }

        function encodeBase64ToJson(base64String) {
            const jsonString = decodeURIComponent(escape(window.atob(base64String)))
            return JSON.parse(jsonString)
        }
    </script>
</body>

</html>