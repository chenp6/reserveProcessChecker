<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <embed style="display: none;" src="../LICENSE.txt">

    <title>各校備取進度查詢</title>
    <link rel="stylesheet" href="./css/loadingHamster.css" type="text/css"> </head>

<body style="font-family: 'Source Code Pro', monospace;">
    <!-- Copy by https://uiverse.io/Nawsome/wet-mayfly-23 -->
    <div id="loadingPage" style="height:100vh; display: flex; gap:2vw; justify-content: center; align-items: center; flex-direction: column; ">
        <div aria-label="Orange and tan hamster running in a metal wheel" role="img" class="wheel-and-hamster">
            <div class="wheel"></div>
            <div class="hamster">
                <div class="hamster__body">
                    <div class="hamster__head">
                        <div class="hamster__ear"></div>
                        <div class="hamster__eye"></div>
                        <div class="hamster__nose"></div>
                    </div>
                    <div class="hamster__limb hamster__limb--fr"></div>
                    <div class="hamster__limb hamster__limb--fl"></div>
                    <div class="hamster__limb hamster__limb--br"></div>
                    <div class="hamster__limb hamster__limb--bl"></div>
                    <div class="hamster__tail"></div>
                </div>
            </div>
            <div class="spoke"></div>
        </div>
        <div style="text-align:center">Please wait while the data is loading<br>Thanks for your patient!ヾ(•ω•`)o</div>
    </div>
    <div id="loadedPage" style="display: none;">
        <nav>
            <a href="./">快速查詢</a> |
            <a href="./group.html">多系組查詢</a>
        </nav>
        <br>
        <div style="border: 0.2rem solid;padding: 2vw;">
            (1)查詢系組備取進度:選擇學校>>選擇考試類別>>選擇系組>>按下【查詢系組備取進度】
            <br> (2)查詢個人備取進度:選擇學校>>選擇考試類別>>選擇系組>>填入考生編號/准考證號碼>>按下【查詢個人備取進度】
        </div>
        <br>
        <select id="schoolSelect">
        <option value="">
            請選擇學校
        </option>
        <option value="NTU">
            國立臺灣大學
        </option>
        <option value="NYCU">
            國立陽明交通大學
        </option>
        <option value="NCKU">
            國立成功大學
        </option>
        <option value="CCU">
            國立中正大學
        </option>
        <option value="NCU">
            國立中央大學
        </option>
        <option value="NCCU">
            國立政治大學
        </option>
        <option value="NKUST">
            國立高雄科技大學
        </option>
    </select>
        <select id="examSelect">
    </select>
        <select id="groupSelect">
    </select>
        <br>
        <label for="userIdInput">考生編號/准考證號碼:</label>
        <input type="text" id="userIdInput" value="" name="userId">
        <br>
        <button onclick="getUserRank()">查詢個人備取進度</button>
        <button onclick="getReserveProcess()">查詢系組備取進度</button>
        <div id="result"></div>
        <br>
        <div>[註]備取進度:目前最後一位報到者的位置 (若尚未有遞補名額，則顯示"目前尚未有遞補名額")</div>
    </div>
    <script>
        let groupInfo = new Map();
        const urlHeader = "http://127.0.0.1:3000"

        checkDatabaseConnection(() => {
            console.log("data loaded!")
        });
        reset();

        function checkDatabaseConnection(onConnected = null) {
            document.getElementById('loadedPage').style.display = "none";
            document.getElementById('loadingPage').style.display = "flex";
            let preStatus = "closed";
            const statusGetter = setInterval(async() => {
                const url = urlHeader + '/getStatus'
                const res = await fetch(url, {
                    method: 'GET'
                })
                const status = (await res.json()).status;
                if (preStatus != status && status == "ok") { //status:ok
                    clearInterval(statusGetter)
                    preStatus = status;
                    document.getElementById('loadingPage').style.display = "none";
                    document.getElementById('loadedPage').style.display = "block";
                    if (onConnected != null) {
                        onConnected();
                    }
                }
            }, 1000)
        }

        function reset() {
            document.getElementById("schoolSelect").selectedIndex = 0;
            document.getElementById("examSelect").selectedIndex = 0;
            document.getElementById("groupSelect").selectedIndex = 0;
            document.getElementById("userIdInput").value = "";
        }

        document.getElementById("schoolSelect").onchange = async function selectSchool() {
            const selectedSchool = document.getElementById("schoolSelect").value;
            if (selectedSchool == "") {
                return;
            }
            const url = urlHeader + `/getExamSelect?school=${selectedSchool}`;
            const res = await fetch(url, {
                method: 'GET',
            })
            if (res.status == 500) {
                const connectAndReselect = checkDatabaseConnection(() => {
                    selectSchool();
                });
            }
            const examList = await res.json()
            let html = " <option value = '' > 請選擇考試類別 </option>"

            for (const exam of examList) {
                html += `<option value = ${exam.examNo} >  ${exam.name}</option>`
            }
            document.getElementById("examSelect").innerHTML = html;
            document.getElementById("groupSelect").innerHTML = "";
            document.getElementById("userIdInput").value = "";
        }




        document.getElementById("examSelect").onchange = async function selectExam() {
            groupInfo = new Map();
            const selectedSchool = document.getElementById("schoolSelect").value;
            const selectedExam = document.getElementById("examSelect").value;
            if (selectedSchool == "" || selectedExam == "") {
                return;
            }

            const url = urlHeader + `/getGroupSelect?school=${selectedSchool}&examNo=${selectedExam}`;
            const res = await fetch(url, {
                method: 'GET',
            })
            if (res.status == 500) {
                const connectAndReselect = checkDatabaseConnection(() => {
                    selectExam();
                });
            }
            const groupList = await res.json()
            let html = " <option value = '' > 請選擇系組 </option>"

            for (const group of groupList) {
                html += `<option value = ${group.groupNo} >  ${group.name}</option>`
                groupInfo.set(group.groupNo, `已報到人數/正取招收人數:${group.registered}/${group.want}=>備取進度:${group.currentReserve}`);
            }
            document.getElementById("groupSelect").innerHTML = html;
            document.getElementById("userIdInput").value = "";

        }



        async function getUserRank() {
            const selectedSchool = document.getElementById("schoolSelect").value;
            const selectedExam = document.getElementById("examSelect").value;
            const selectedGroup = document.getElementById("groupSelect").value;
            const userId = document.getElementById("userIdInput").value;
            if (selectedSchool == "" || selectedExam == "" || selectedGroup == "" || userId == "") {
                return;
            }
            const groupId = selectedSchool + "_" + selectedExam + "_" + selectedGroup;

            const url = urlHeader + `/getUserRank?groupId=${groupId}&userId=${userId}`;
            const res = await fetch(url, {
                method: 'GET',
            })
            if (res.status == 500) {
                checkDatabaseConnection(() => {
                    getUserRank();
                });
                return;
            }

            const result = document.getElementById("result");
            const userRank = await res.json();
            if (userRank == null)
                result.innerText = `查無此考生`;
            else {
                result.innerText = `名次:${userRank.rank} , 報到狀況:${userRank.status}`;
            }


            const updateTimeUrl = urlHeader + `/getUpdateTime?school=${selectedSchool}&examNo=${selectedExam}`;
            const updateTimeRes = await fetch(updateTimeUrl, {
                method: 'GET',
            })
            if (updateTimeRes.status == 500) {
                return;
            }
            const updateTime = await updateTimeRes.json();
            if (updateTime != null) {
                result.innerText += `\n更新時間:${updateTime.time}`;
            }

        }

        async function getReserveProcess() {
            const selectedSchool = document.getElementById("schoolSelect").value;
            const selectedExam = document.getElementById("examSelect").value;
            const selectedGroup = document.getElementById("groupSelect").value;

            if (selectedSchool == "" || selectedExam == "" || selectedGroup == "") {
                return;
            }
            const groupInput = document.getElementById("groupInput");
            result.innerText = groupInfo.get(selectedGroup);

            const updateTimeUrl = urlHeader + `/getUpdateTime?school=${selectedSchool}&examNo=${selectedExam}`;
            const updateTimeRes = await fetch(updateTimeUrl, {
                method: 'GET',
            })
            if (updateTimeRes.status == 500) {
                return;
            }
            const updateTime = await updateTimeRes.json();
            if (updateTime != null) {
                result.innerText += `\n更新時間:${updateTime.time}`;
            }
        }
    </script>
</body>

</html>